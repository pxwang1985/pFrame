
var PCKEY = {};


PCKEY.ENTER = 13;
PCKEY.MENU = 36; // HOME
PCKEY.EXIT = 27; // HOME

PCKEY.UP = 38;
PCKEY.DOWN = 40;
PCKEY.LEFT = 37;
PCKEY.RIGHT = 39;

PCKEY.ZERO = 48;
PCKEY.ONE = 49;
PCKEY.TWO = 50;
PCKEY.THREE = 51;
PCKEY.FOUR = 52;
PCKEY.FIVE = 53;
PCKEY.SIX = 54;
PCKEY.SEVEN = 55;
PCKEY.EIGHT = 56;
PCKEY.NINE = 57;

PCKEY.NUM0 = 96;
PCKEY.NUM1 = 97;
PCKEY.NUM2 = 98;
PCKEY.NUM3 = 99;
PCKEY.NUM4 = 100;
PCKEY.NUM5 = 101;
PCKEY.NUM6 = 102;
PCKEY.NUM7 = 103;
PCKEY.NUM8 = 104;
PCKEY.NUM9 = 105;


PCKEY.POWER = 0;
PCKEY.PAGE_UP = 0;
PCKEY.PAGE_DOWN = 0;
PCKEY.CHANPREV = 0;
PCKEY.MUTE = 0;
PCKEY.VOL_UP = 0;
PCKEY.VOL_DOWN = 0;
PCKEY.RED = 112;
PCKEY.GREEN = 0;
PCKEY.YELLOW = 114;
PCKEY.BLUE = 0;
PCKEY.TVGUIDE = 0;
PCKEY.FAV = 0;
PCKEY.HELP = 0;
PCKEY.D = 0;
PCKEY.GAME = 0;
PCKEY.NVOD = 0;
PCKEY.INFO = 0;
PCKEY.HDMI = 0;
PCKEY.MAIL = 0;
PCKEY.SETTING = 0;
PCKEY.STEREO = 0;
PCKEY.SCREEN = 0;
PCKEY.VOD = 0;
PCKEY.AD = 0;
PCKEY.MEDIA = 0;
PCKEY.RECALL = 0;
PCKEY.INPUT = 0;
PCKEY.SEARCH = 0;
PCKEY.VOID = 0;
PCKEY.TVAUDIO = 0;
PCKEY.PLAYSTOP = 0;
PCKEY.SHOW = 0;
PCKEY.SHIFT = 0;
PCKEY.SUBTITLE = 0;
PCKEY.CHANNEL_LIST = 0;
PCKEY.BUY = 0;
PCKEY.PLAY = 0;
PCKEY.STOP = 0;
PCKEY.BACK = 0;
PCKEY.FORWARD = 0;
PCKEY.PRE = 0;
PCKEY.NEXT = 0;
PCKEY.REC = 0;
PCKEY.PAUSE = 0;
PCKEY.F1 = 0;
PCKEY.F2 = 0;
PCKEY.F3 = 0;
PCKEY.WEBVOD = 0;
PCKEY.BACK_TO_TVPLAY = 0;
PCKEY.MENUEXIT = 0;
PCKEY.RIGHT_START = 0;
PCKEY.RIGHT_END = 0;
PCKEY.LEFT_START = 0;
PCKEY.LEFT_END = 0;
PCKEY.CH_UP = 0;
PCKEY.CH_DOWN = 0;
PCKEY.TEST = 0;



PCKEY.FT_UP = 20171025; //96 20171025
PCKEY.FT_DOWN = 20171026;
PCKEY.FT_LEFT = 20171027;
PCKEY.FT_RIGHT = 20171028;
PCKEY.FT_POWER = 20171029;
PCKEY.FT_ENTER = 20171030;
PCKEY.FT_MENU = 20171031;


var STBKEY = {};

STBKEY.ENTER = 13;
STBKEY.MENU = 18; // HOME
STBKEY.EXIT = 27; // HOME

STBKEY.UP = 38;
STBKEY.DOWN = 40;
STBKEY.LEFT = 37;
STBKEY.RIGHT = 39;

STBKEY.ZERO = 48;
STBKEY.ONE = 49;
STBKEY.TWO = 50;
STBKEY.THREE = 51;
STBKEY.FOUR = 52;
STBKEY.FIVE = 53;
STBKEY.SIX = 54;
STBKEY.SEVEN = 55;
STBKEY.EIGHT = 56;
STBKEY.NINE = 57;

STBKEY.NUM0 = 96;
STBKEY.NUM1 = 97;
STBKEY.NUM2 = 98;
STBKEY.NUM3 = 99;
STBKEY.NUM4 = 100;
STBKEY.NUM5 = 101;
STBKEY.NUM6 = 102;
STBKEY.NUM7 = 103;
STBKEY.NUM8 = 104;
STBKEY.NUM9 = 105;

STBKEY.POWER = 62728;
STBKEY.PAGE_UP = 0;
STBKEY.PAGE_DOWN = 0;
STBKEY.CHANPREV = 0;
STBKEY.MUTE = 0;
STBKEY.VOL_UP = 62737;
STBKEY.VOL_DOWN = 62738;
STBKEY.RED = 112;
STBKEY.GREEN = 113;
STBKEY.YELLOW = 114;
STBKEY.BLUE = 62722;
STBKEY.TVGUIDE = 62741;
STBKEY.FAV = 0;
STBKEY.HELP = 0;
STBKEY.D = 0;
STBKEY.GAME = 0;
STBKEY.NVOD = 0;
STBKEY.EPG = 62730;
STBKEY.INFO = 62720;
STBKEY.HDMI = 0;
STBKEY.MAIL = 62727;
STBKEY.SETTING = 0;
STBKEY.STEREO = 62731;
STBKEY.SCREEN = 0;
STBKEY.VOD = 62735;
STBKEY.AD = 0;
STBKEY.MEDIA = 0;
STBKEY.RECALL = 0;
STBKEY.INPUT = 0;
STBKEY.SEARCH = 62743;
STBKEY.VOID = 0;
STBKEY.TVAUDIO = 0;
STBKEY.PLAYSTOP = 0;
STBKEY.SHOW = 0;
STBKEY.SHIFT = 0;
STBKEY.SUBTITLE = 0;
STBKEY.CHANNEL_LIST = 0;
STBKEY.BUY = 0;
STBKEY.PLAY = 62721;
STBKEY.STOP = 62724;
STBKEY.BACK = 62742;
STBKEY.FORWARD = 62725;
STBKEY.BACKWARD = 62726;
STBKEY.PRE = 0;
STBKEY.NEXT = 0;
STBKEY.REC = 62723;
STBKEY.PAUSE = 62733;
STBKEY.F1 = 0;
STBKEY.F2 = 0;
STBKEY.F3 = 0;
STBKEY.WEBVOD = 62736;
STBKEY.BACK_TO_TVPLAY = 62741; 
STBKEY.MENUEXIT = 0;
STBKEY.RIGHT_START = 0;
STBKEY.RIGHT_END = 0;
STBKEY.LEFT_START = 0;
STBKEY.LEFT_END = 0;
STBKEY.CH_UP = 62739;
STBKEY.CH_DOWN = 62740;
STBKEY.TEST = 0;


STBKEY.FT_UP = 20171025; //96 20171025
STBKEY.FT_DOWN = 20171026;
STBKEY.FT_LEFT = 20171027;
STBKEY.FT_RIGHT = 20171028;
STBKEY.FT_POWER = 20171029;
STBKEY.FT_ENTER = 20171030;
STBKEY.FT_MENU = 20171031;


var KEYS = {};
function System_Debug(logstr)
{
	//console.log(logstr)
}

function Stb_Debug(logstr)
{
	if ((typeof testObj != 'undefined') && (typeof testObj.pvr_add_book != 'undefined'))
		testObj.add(logstr);
}

function System_KeyCode(event) {
	var code = 0;
	if (typeof (event) === "object") {
		code = event.keyCode;
	} else {
		code = event;
	}
	return code;
}

function Get_NetIP()
{
	return "192.168.30.154";
}


function Get_Input() {
	return "256.123.32.21";
}
function System_Init() {
}
function play_last_channel() {
    if ((typeof testObj != 'undefined')&&(typeof testObj.play_last_channel != 'undefined'))
    	{
		testObj.play_last_channel();
	}
}


function ChannelUp() {
	//app_zapping_signal();
	if ((typeof testObj != 'undefined') && (typeof testObj.app_zapping_signal != 'undefined'))
		testObj.app_zapping_signal(0, 0, 1);
}

function ChannelDown() {
	//app_zapping_signal();
	if ((typeof testObj != 'undefined') && (typeof testObj.app_zapping_signal != 'undefined'))
		testObj.app_zapping_signal(1, 0, 1);
}

function GetLastStatus() {
	var dat;
	if ((typeof testObj != 'undefined') && (typeof testObj.get_last_channel_service != 'undefined'))
		dat = JSON.parse(testObj.get_last_channel_service());
	return dat;
}


function GetChannelTotal() {
	var total = 0;
	if ((typeof testObj != 'undefined') && (typeof testObj.db_get_serv_totalnum != 'undefined'))
		total = testObj.db_get_serv_totalnum();
	return total;
}

var chnanel_info = null;
var ch_id = 0;

function GetAllChannel() {
	var dat = '';
	if ((typeof testObj != 'undefined') && (typeof testObj.db_get_all_serv != 'undefined')) {
		var json = testObj.db_get_all_serv();
		dat = JSON.parse(json);
	}
	chnanel_info = dat;
	return chnanel_info;
}

function GetChannelInfo() {
	return dat;
}
function  Time_Convert_MJD_to_YMD(mjd_date,dat)
{
	var y1, m1, k, mjd;

	mjd = mjd_date & 0x0000ffff;
	y1 = (mjd * 100 - 1507820) / 36525;
	m1 = (mjd * 10000 - 149561000 - ((parseInt(y1) * 3652500) / 10000) * 10000) / 306001;
	//*date = ((mjd - 14956) * 10000 -
	//	((y1 * 3652500)/10000) * 10000 -
	//	((m1 * 306001)/10000) * 10000) / 10000;

	dat.date = ((mjd - 14956) * 10000 -
		((y1 * 3652500) / 10000) * 10000 -
		((m1 * 306001) / 10000) * 10000) / 10000;;

	if ((m1 == 14) || (m1 == 15))
		k = 1;
	else
		k = 0;

	dat.year = (y1 + k);
	//printf(":::::%d\n",*year);
	dat.year = dat.year + 1900;
	dat.month = m1 - 1 - k * 12;
	//week = (((int)mjd +2)%7) + 1;
	if (dat.month > 12) dat.month = 1;
	//if(week > 6) week = 0;
	if (dat.date > 31) dat.date = 1;
	//printf("hsd nyr = %d %d %d\n",*year,*month,*date);
}

function bcd_to_bin (bcd)
{
	var   e1 = 0, e2 = 0, e3 = 0,  e4 = 0, e5 = 0, e6 = 0,  e7 = 0, e8 = 0;

	e1 = ((bcd & 0xf0000000) >> 28);
	e2 = ((bcd & 0xf000000) >> 24);
	e3 = ((bcd & 0xf00000) >> 20);
	e4 = ((bcd & 0xf0000) >> 16);
	e5 = ((bcd & 0xf000) >> 12);
	e6 = ((bcd & 0xf00) >> 8);
	e7 = ((bcd & 0xf0) >> 4);
	e8 = (bcd & 0xf);
	if(e1 != 0)
	{	e1 = e1 * 10000000;	}
	if(e2 != 0)
	{	e2 = e2 * 1000000;	}
	if(e3 != 0)
	{	e3 = e3 * 100000;	}
	if(e4 != 0)
	{	e4 = e4 * 10000;	}
	if(e5 != 0)
	{	e5 = e5 * 1000;	}
	if(e6 != 0)
	{	e6 = e6 * 100;	}
	if(e7 != 0)
	{	e7 = e7 * 10;	}
	return (e1 + e2 + e3 + e4 + e5 + e6 + e7 + e8);
}

function Time_Convert_BCD_to_HMS(bcd_time,time)
{
	var bin;
	bin = bcd_to_bin(bcd_time);
	time.hour = parseInt(bin / 10000);
	time.min = (bin % 10000) / 100;
	time.sec = bin % 100;
}
function Time_Convert_Orig_to_Td(origtime)
{
	var tdtime = {};
	tdtime.year = 0;
	tdtime.month = 0;
	tdtime.date = 0;
	tdtime.week = 0;
	tdtime.hour = 0;
	tdtime.min = 0;
	tdtime.sec = 0;
	//Time_Convert_MJD_to_YMD(origtime.mjd_date, tdtime);
	var MJD = origtime.mjd_date;
	var Y = parseInt((MJD - 15078.2) / 365.25);
	var M = parseInt([MJD - 14956.1 - parseInt(Y * 365.25)] / 30.6001);
	var D = MJD - 14956 - parseInt(Y * 365.25) - parseInt(M * 30.6001);
	var K = 0;
	if (M == 14 || M == 15)
		K = 1;
	Y = Y + K;
	M = M - 1 - K * 12;

	tdtime.year = 1900 + Y;
	tdtime.month = M;
	tdtime.date = D;

	Time_Convert_BCD_to_HMS(origtime.bcd_time, tdtime);
	/*����MJD����WD*/
	tdtime.week = ((2 + origtime.mjd_date) % 7) + 1;
	if(tdtime.week > 6) 
    {
		tdtime.week = 0;
	}
	return tdtime;
}


function get_event_time(start_time, duration)
{
	var time = {};
	time.end = {};
	time.end["year"] = 0;
	time.end["month"] = 0;
	time.end["date"] = 0;
	time.end["week"] = 0;
	time.end["hour"] = 0;
	time.end["min"] = 0;
	time.end["sec"] = 0;
	time.start = Time_Convert_Orig_to_Td(start_time);
	for (var attr in time.start) {
		time.end[attr] = time.start[attr];
	}

	time.end.hour += bcd_to_bin(duration[0]);
	time.end.min += bcd_to_bin(duration[1]);
	time.end.sec += bcd_to_bin(duration[2]);

	time.end.min += parseInt(time.end.sec / 60);
	time.end.sec %= 60;
	time.end.hour += parseInt(time.end.min / 60);
	time.end.min %= 60;
	var tTime = start_time;
	tTime.mjd_date += parseInt(time.end.hour / 24);
	time.end.hour %= 24;

	var tPtime = Time_Convert_Orig_to_Td(tTime);


	time.end.date = tPtime.date;
	time.end.week = tPtime.week;
	time.end.month = tPtime.month;
	time.end.year = tPtime.year;
	//	printf("\n\n=end====day[%d] hour[%d] min[%d]",time_date->date,time_date->hour,time_date->minute);

	return time;
}


function GetChannelInfoByServiceID(service_id) {
	var channle, i;
	if ((typeof chnanel_info != 'undefined') && chnanel_info.length > 0) {
		for (i = 0; i < chnanel_info.length; i++) {
			if (chnanel_info[i].service_id == service_id) {
				channle = chnanel_info[i];
				break;
			}
		}
	}
	else {
	}
	return channle;
}

function MsgCallback(obj) {
	//console.log("=====  debug MsgCallback", obj);

	obj = JSON.parse(obj);
	if ((typeof obj != 'undefined') && (typeof obj.message_type != 'undefined')) {
		switch (obj.message_type) {

			case 3:
				if (typeof obj.sBooking != 'undefined') {
					if (obj.sBooking.wakeup_mode == 0)
						pvr_start_rec(obj.sBooking);
					else {
						var channle = GetChannelInfoByServiceID(obj.sBooking.uiServiceID);
						if (typeof channle != 'undefined') {
							testObj.app_zapping_signal(5, channle.channel_number, channle.service_type);
							APP.get().APPSelect("player")
						}
					}
				}
				break;

			case 4:
				pvr_stop_rec();
				break;

			case 5:

				if (typeof obj.Event != 'undefined')
					pvr_callback(obj.Event.Type, obj.Event.ChnID);
				break;
		}
	}
}

function CallbackInit() {
	if (typeof testObj != 'undefined')
		testObj.callback_message_notify = MsgCallback;
};

var PVR_TYPE = new Object();
PVR_TYPE.PVR_EVENT_PLAY_EOF = 0x001;
PVR_TYPE.PVR_EVENT_PLAY_SOF = 0x002;
PVR_TYPE.PVR_EVENT_PLAY_ERROR = 0x003;
PVR_TYPE.PVR_EVENT_PLAY_REACH_REC = 0x004;
PVR_TYPE.PVR_EVENT_PLAY_RESV = 0x00f;
PVR_TYPE.PVR_EVENT_REC_DISKFULL = 0x010;
PVR_TYPE.PVR_EVENT_REC_ERROR = 0x011;
PVR_TYPE.PVR_EVENT_REC_OVER_FIX = 0x012;
PVR_TYPE.EVENT_REC_REACH_PLAY = 0x013;
PVR_TYPE.PVR_EVENT_REC_DISK_SLOW = 0x014;
PVR_TYPE.PVR_EVENT_REC_RESV = 0x01f;

function pvr_callback(type, chnid) {

	console.log("=====  debug pvr_callback " + type);
	switch (type) {
		case PVR_TYPE.PVR_EVENT_PLAY_EOF:
			pvr_play_stop();
			break;

		case PVR_TYPE.PVR_EVENT_REC_ERROR:
		case PVR_TYPE.PVR_EVENT_REC_DISKFULL:
			pvr_stop_rec();
			break;
	}
}

function pvr_start_rec(sBooking) {

	console.log("Enter pvr_start_rec!");
	if ((typeof testObj != 'undefined') && (typeof testObj.pvr_start_rec != 'undefined')) {
		var strJson;

		console.log("find pvr_start_rec!");
		strJson = JSON.stringify(sBooking);
		var ret = testObj.pvr_start_rec(strJson);
		console.log("pvr_start_rec ret:" + ret);
	}
}

function pvr_stop_rec() {

	console.log("Enter pvr_stop_rec!");
	if ((typeof testObj != 'undefined') && (typeof testObj.pvr_stop_rec != 'undefined')) {
		var ret = testObj.pvr_stop_rec();
		console.log("pvr_stop_rec ret:" + ret);
	}
}

function pvr_play_start(path) {

	console.log("Enter pvr_play_start!");
    if ((typeof testObj != 'undefined') 
		&& (typeof testObj.pvr_start_play != 'undefined')
		&& (typeof testObj.stop_play_dvb != 'undefined')
		&& (typeof testObj.blank_window != 'undefined')
		&& (typeof testObj.background_stop != 'undefined')) {

		testObj.stop_play_dvb();
		testObj.blank_window();
		testObj.background_stop();

		console.log("pvr_start_play path:" + path);
		var ret = testObj.pvr_start_play(path);
		console.log("pvr_start_play ret:" + ret);
	}
}

function pvr_play_stop() {

	console.log("Enter pvr_play_stop!");
    if ((typeof testObj != 'undefined') 
		&& (typeof testObj.pvr_stop_play != 'undefined')
		&& (typeof testObj.background_start != 'undefined')
		&& (typeof testObj.app_zapping_signal != 'undefined')) {
		var ret = testObj.pvr_stop_play();
		testObj.background_start();
		testObj.app_zapping_signal(5, chnanel_info[ch_id].channel_number, chnanel_info[ch_id].service_type);
		console.log("pvr_stop_play ret:" + ret);
	}
}

function pvr_is_play() {

	console.log("Enter pvr_is_play!");
    if ((typeof testObj != 'undefined') 
		&& (typeof testObj.pvr_is_play != 'undefined')) {

		return testObj.pvr_is_play();
	}
	return false;
}

function pvr_play_get_filestatus() {

	console.log("Enter pvr_play_get_filestatus!");
    if ((typeof testObj != 'undefined') 
		&& (typeof testObj.pvr_get_playfile_status != 'undefined')) {

		return JSON.parse(testObj.pvr_get_playfile_status());
	}
	return null;
}

function pvr_play_get_status() {

	console.log("Enter pvr_play_get_status!");
    if ((typeof testObj != 'undefined') 
		&& (typeof testObj.pvr_get_play_status != 'undefined')) {

		return JSON.parse(testObj.pvr_get_play_status());
	}
	return null;
}

function pvr_play_do(type) {

	console.log("Enter pvr_play_do!");
    if ((typeof testObj != 'undefined') 
		&& (typeof testObj.pvr_do_play != 'undefined')) {

		return JSON.parse(testObj.pvr_do_play(parseInt(type)));
	}
	return null;
}

function epg_add_book(wakeup_mode)
{

	console.log("Enter epg_add_book!");
	if ((typeof testObj != 'undefined') && (typeof testObj.pvr_add_book != 'undefined')) {
		var sBooking = new Object();
		var strJson;

		console.log("find pvr_add_book!");

		var channle;
		if ((typeof chnanel_info != 'undefined') && chnanel_info.length > 0) {
			channle = chnanel_info[0];
			console.log("length:", chnanel_info.length);
			console.log("chnanel_info:", chnanel_info);
		}
		else {
			console.log("No find channel");
			return;
		}

		sBooking.Serial_no = 0;
		sBooking.eModuleType = 1;
		sBooking.uiServiceID = channle.service_id;
		sBooking.ucServiceType = channle.service_type;
		sBooking.uiTSID = channle.network_id;
		sBooking.tp_id = channle.tp_id;
		sBooking.Rec_mode = 1;
		sBooking.wakeup_mode = wakeup_mode;

		sBooking.date = 20110101;
		sBooking.starttime = 0952;
		if (wakeup_mode == 0)
			sBooking.duration = 0002;
		else
			sBooking.duration = 0;
		sBooking.standby = 0;
		sBooking.fastrec = 0;

		sBooking.wakeup_channel = channle.channel_name;

		strJson = JSON.stringify(sBooking);
		testObj.pvr_add_book(strJson);
	}
}


function indexList(obj, start, h, max_item, index) {
	var start_index = -(parseInt(obj.css("top")) / h);
	var end_index = start_index + max_item;
	if (index < start_index) {
		obj.css("top", (-index * h + start) + "px");
	}
	else if(index > end_index) {
		obj.css("top", (-(index - max_item) * h + start) + "px");
	}
}